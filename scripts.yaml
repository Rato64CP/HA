nova_skripta:
  sequence:
  - target:
      entity_id: switch.sonoff_100132ebac_1
    action: switch.turn_on
    data: {}
  - delay:
      hours: 0
      minutes: 1
      seconds: 15
      milliseconds: 0
  - target:
      entity_id: switch.sonoff_100132ebac_1
    action: switch.turn_off
    data: {}
  - delay:
      hours: 0
      minutes: 1
      seconds: 25
      milliseconds: 0
  - target:
      entity_id: switch.sonoff_100132ebac_4
    action: switch.turn_on
    data: {}
  - delay: 00:10:00
  - target:
      entity_id: switch.sonoff_100132ebac_4
    action: switch.turn_off
    data: {}
  mode: single
  alias: Najava musko
  description: ''
najava_zensko:
  alias: Najava zensko
  description: ''
  mode: single
  sequence:
  - target:
      entity_id: switch.sonoff_100132ebac_2
    action: switch.turn_on
    data: {}
  - delay:
      hours: 0
      minutes: 1
      seconds: 15
      milliseconds: 0
  - target:
      entity_id: switch.sonoff_100132ebac_2
    action: switch.turn_off
    data: {}
  - delay:
      hours: 0
      minutes: 1
      seconds: 5
      milliseconds: 0
  - target:
      entity_id: switch.sonoff_100132ebac_4
    action: switch.turn_on
    data: {}
  - delay: 00:10:00
  - target:
      entity_id: switch.sonoff_100132ebac_4
    action: switch.turn_off
    data: {}
klime_crkva_off:
  alias: Klime crkva OFF / deblokiraj
  sequence:
  - choose:
    - conditions:
      - condition: state
        entity_id: input_boolean.blokiraj_automatsko_hladenje
        state: 'off'
      sequence:
      - target:
          entity_id:
          - climate.9424b8b8c89e
          - climate.9424b8b8c8a4
          - climate.9424b8b8c92a
          - climate.9424b8b87ea5
          - climate.9424b8698184
          - climate.c039370a331f
        action: climate.turn_off
      - target:
          entity_id: input_boolean.blokiraj_automatsko_hladenje
        action: input_boolean.turn_on
      - delay: 02:00:00
      - target:
          entity_id: input_boolean.blokiraj_automatsko_hladenje
        action: input_boolean.turn_off
    - conditions:
      - condition: state
        entity_id: input_boolean.blokiraj_automatsko_hladenje
        state: 'on'
      sequence:
      - target:
          entity_id: input_boolean.blokiraj_automatsko_hladenje
        action: input_boolean.turn_off
  mode: restart
kazaljke_impuls_poz_6_s:
  alias: Kazaljke – impuls POZ (6 s)
  mode: single
  sequence:
  - action: switch.turn_off
    target:
      entity_id: switch.kazaljke_negativna
  - action: switch.turn_on
    target:
      entity_id: switch.kazaljke_pozitivna
  - delay: 00:00:06
  - action: switch.turn_off
    target:
      entity_id: switch.kazaljke_pozitivna
  description: ''
kazaljke_impuls_neg_6_s:
  alias: Kazaljke – impuls NEG (6 s)
  mode: single
  sequence:
  - action: switch.turn_off
    target:
      entity_id: switch.kazaljke_pozitivna
  - action: switch.turn_on
    target:
      entity_id: switch.kazaljke_negativna
  - delay: 00:00:06
  - action: switch.turn_off
    target:
      entity_id: switch.kazaljke_negativna
  description: ''
kazaljke_automatsko_dovodenje_catch_up:
  alias: Kazaljke – automatsko dovođenje (catch-up)
  mode: restart
  sequence:
  - variables:
      dst_hold_active: '{{ is_state(''input_boolean.kazaljke_dst_hold'',''on'') }}'
  - if:
    - condition: template
      value_template: '{{ dst_hold_active }}'
    then:
    - action: input_datetime.set_datetime
      target:
        entity_id: input_datetime.kazaljke_zadnji_pomak
      data:
        date: '{{ now().strftime(''%Y-%m-%d'') }}'
        time: '{{ now().replace(second=0, microsecond=0).strftime(''%H:%M:%S'') }}'
    - action: input_boolean.turn_off
      target:
        entity_id:
        - input_boolean.kazaljke_dst_hold
        - input_boolean.kazaljke_stop
      data: {}
    - stop: 'DST hold aktivan: poravnato bez impulsa.'
  - action: input_boolean.turn_on
    target:
      entity_id: input_boolean.kazaljke_stop
    data: {}
  - variables:
      last_str: '{{ states(''input_datetime.kazaljke_zadnji_pomak'') }}'
      last_ok: '{{ last_str is string and last_str not in [''unknown'',''unavailable'','''']
        }}'
  - if:
    - condition: template
      value_template: '{{ not last_ok }}'
    then:
    - action: input_datetime.set_datetime
      target:
        entity_id: input_datetime.kazaljke_zadnji_pomak
      data:
        date: '{{ now().strftime(''%Y-%m-%d'') }}'
        time: '{{ now().replace(second=0, microsecond=0).strftime(''%H:%M:%S'') }}'
  - variables:
      now_dt: "{{ now().replace(second=0, microsecond=0) }}"
      last_dt: "{{ as_datetime(states('input_datetime.kazaljke_zadnji_pomak')) }}"
      delta: "{{ ((now_dt - last_dt).total_seconds() / 60) | int }}"
      adj_dt: "{{ now_dt - timedelta(minutes=(delta % 720)) }}"
  - action: input_datetime.set_datetime
    target:
      entity_id: input_datetime.kazaljke_zadnji_pomak
    data:
      date: "{{ as_datetime(adj_dt).strftime('%Y-%m-%d') }}"
      time: "{{ as_datetime(adj_dt).strftime('%H:%M:%S') }}"
  - repeat:
      while:
      - condition: template
        value_template: '{% set last = as_datetime(states(''input_datetime.kazaljke_zadnji_pomak''))
          %} {% set target = now().replace(second=0, microsecond=0) %} {{ last < target
          }}'
      sequence:
      - variables:
          last: '{{ as_datetime(states(''input_datetime.kazaljke_zadnji_pomak''))
            }}'
          step_time: '{{ last + timedelta(minutes=1) }}'
          even: '{{ (step_time.minute | int) % 2 == 0 }}'
      - choose:
        - conditions:
          - condition: template
            value_template: '{{ even }}'
          sequence:
          - action: script.turn_on
            target:
              entity_id: script.kazaljke_impuls_poz_6_s
            data: {}
        - conditions: []
          sequence:
          - action: script.turn_on
            target:
              entity_id: script.kazaljke_impuls_neg_6_s
            data: {}
      - action: input_datetime.set_datetime
        target:
          entity_id: input_datetime.kazaljke_zadnji_pomak
        data:
          date: '{{ as_datetime(step_time).strftime(''%Y-%m-%d'') }}'
          time: '{{ as_datetime(step_time).strftime(''%H:%M:%S'') }}'
      - action: counter.increment
        target:
          entity_id: counter.kazaljke_broj_pomaka
        data: {}
      - wait_template: "{{ is_state('switch.kazaljke_pozitivna','off')\n   and is_state('switch.kazaljke_negativna','off')
          }}"
        timeout: 00:00:10
        continue_on_timeout: true
  - action: input_boolean.turn_off
    target:
      entity_id: input_boolean.kazaljke_stop
    data: {}
kazaljke_primijeni_rucnu_poziciju_12h_i_dovedi_na_sada:
  alias: Kazaljke – primijeni ručnu poziciju (12h) i dovedi na sada
  mode: single
  sequence:
  - action: input_boolean.turn_on
    target:
      entity_id: input_boolean.kazaljke_stop
  - variables:
      pos_str: '{{ states(''input_datetime.kazaljke_rucna_pozicija'') }}'
      pos_ok: '{{ pos_str not in [''unknown'',''unavailable'',''''] }}'
  - if:
    - condition: template
      value_template: '{{ not pos_ok }}'
    then:
    - action: persistent_notification.create
      data:
        title: Kazaljke – ručna pozicija
        message: Postavi vrijeme u 'Kazaljke – ručna pozicija (12h)'.
    - stop: Nema ručne pozicije.
  - variables:
      pos_h: '{{ strptime(pos_str, ''%H:%M:%S'').hour }}'
      pos_m: '{{ strptime(pos_str, ''%H:%M:%S'').minute }}'
      now_dt: '{{ now() }}'
      cand: '{{ now_dt.replace(hour=pos_h, minute=pos_m, second=0, microsecond=0)
        }}'
      last_dt: "{% set c = as_datetime(cand) %} {% if c > now_dt %}\n  {{ (c - timedelta(hours=12))
        }}\n{% else %}\n  {{ c }}\n{% endif %}"
  - action: input_datetime.set_datetime
    target:
      entity_id: input_datetime.kazaljke_zadnji_pomak
    data:
      date: '{{ as_datetime(last_dt).strftime(''%Y-%m-%d'') }}'
      time: '{{ as_datetime(last_dt).strftime(''%H:%M:%S'') }}'
  - action: script.turn_on
    target:
      entity_id: script.kazaljke_automatsko_dovodenje_catch_up
  - action: input_boolean.turn_off
    target:
      entity_id: input_boolean.kazaljke_stop
  description: ''
cekic_muski_impuls_150_ms:
  alias: Čekić muški – impuls 150 ms
  mode: parallel
  sequence:
  - target:
      entity_id: switch.cekic_musko
    action: switch.turn_on
  - delay:
      milliseconds: 150
  - target:
      entity_id: switch.cekic_musko
    action: switch.turn_off
  description: ''
cekic_zenski_impuls_150_ms:
  alias: Čekić ženski – impuls 150 ms
  mode: parallel
  sequence:
  - target:
      entity_id: switch.cekic_zensko
    action: switch.turn_on
  - delay:
      milliseconds: 150
  - target:
      entity_id: switch.cekic_zensko
    action: switch.turn_off
  description: ''
otkucavanje_puni_sat_muski:
  alias: Otkucavanje – puni sat (muški)
  mode: single
  fields:
    count:
      name: Broj udaraca
      required: true
      selector:
        number:
          min: 1
          max: 12
          mode: box
  sequence:
  - repeat:
      count: '{{ max(1, (count|int)) }}'
      sequence:
      - condition: state
        entity_id: binary_sensor.otkucavanje_dopusteno_sada
        state: 'on'
      - target:
          entity_id: switch.cekic_musko
        action: switch.turn_on
      - delay:
          milliseconds: 150
      - target:
          entity_id: switch.cekic_musko
        action: switch.turn_off
      - delay:
          seconds: 2
  description: ''
otkucavanje_pola_sata_zenski_1:
  alias: Otkucavanje – pola sata (ženski 1×)
  mode: single
  sequence:
  - condition: state
    entity_id: binary_sensor.otkucavanje_dopusteno_sada
    state: 'on'
  - target:
      entity_id: switch.cekic_zensko
    action: switch.turn_on
  - delay:
      milliseconds: 150
  - target:
      entity_id: switch.cekic_zensko
    action: switch.turn_off
  description: ''
motor_ploce_impuls_poz_neg:
  alias: Motor ploče – impuls POZ + NEG
  mode: single
  sequence:
  - action: switch.turn_on
    target:
      entity_id: switch.motor_poz
  - delay: 00:00:01
  - action: switch.turn_off
    target:
      entity_id: switch.motor_poz
  - delay: 00:00:01
  - action: switch.turn_on
    target:
      entity_id: switch.motor_neg
  - delay: 00:00:01
  - action: switch.turn_off
    target:
      entity_id: switch.motor_neg
  description: ''
